# 文件系统

在 Libuv 中，文件读写等操作是通过 文件系统（File System，简称 FS）API 实现的。Libuv 提供了异步的文件 I/O 操作，能够高效地处理文件读写、文件属性获取、目录操作等任务。

Libuv 的文件系统操作与套接字操作不同。套接字操作使用的是操作系统提供的非阻塞操作，而文件系统操作在内部使用的是阻塞函数（操作系统提供的文件读写函数是阻塞的），这些函数是在线程池中调用的，并且在需要与应用程序交互时通知注册到事件循环的观察者，从而实现非阻塞调用。

## 核心 API

Libuv 的文件系统 API 主要包括以下函数：

### 打开文件 `uv_fs_open`

异步打开文件。

```c
void uv_fs_open(uv_loop_t* loop, uv_fs_t* req, const char* path, int flags, int mode, uv_fs_cb cb);
```

参数说明：

- `loop`：事件循环对象。
- `req`：文件系统请求对象。
- `path`：文件路径。
- `flags`：打开文件的标志（如 `O_RDONLY`、`O_WRONLY`、`O_RDWR` 等）。
- `mode`：文件权限（如 `0644`）。
- `cb`：回调函数，操作完成后调用。

### 读取文件 uv_fs_read

异步读取文件。

```c
void uv_fs_read(uv_loop_t* loop, uv_fs_t* req, uv_file file, const uv_buf_t bufs[], unsigned int nbufs, int64_t offset, uv_fs_cb cb);
```

参数说明：

- `loop`：事件循环对象。
- `req`：文件系统请求对象。
- `file`：文件描述符（由 `uv_fs_open` 返回）。
- `bufs`：缓冲区数组。
- `nbufs`：缓冲区数量。
- `offset`：读取的起始偏移量（`-1` 表示从当前位置读取）。
- `cb`：回调函数。

### 写入文件 uv_fs_write

异步写入文件。

```c
void uv_fs_write(uv_loop_t* loop, uv_fs_t* req, uv_file file, const uv_buf_t bufs[], unsigned int nbufs, int64_t offset, uv_fs_cb cb);
```

参数说明：

- `loop`：事件循环对象。
- `req`：文件系统请求对象。
- `file`：文件描述符。
- `bufs`：缓冲区数组。
- `nbufs`：缓冲区数量。
- `offset`：写入的起始偏移量（`-1` 表示从当前位置写入）。
- `cb`：回调函数。

### 关闭文件 uv_fs_close

异步关闭文件。

```c
void uv_fs_close(uv_loop_t* loop, uv_fs_t* req, uv_file file, uv_fs_cb cb);
```

参数说明：

- `loop`：事件循环说明。
- `req`：文件系统请求对象。
- `file`：文件描述符。
- `cb`：回调函数。

### 其他常用 API

- **`uv_fs_stat`**：获取文件属性。
- **`uv_fs_unlink`**：删除文件。
- **`uv_fs_mkdir`**：创建目录。
- **`uv_fs_readdir`**：读取目录内容。
- **`uv_fs_rename`**：重命名文件或目录。

## 使用示例

### 简单异步读写操作

以下是一个完整的示例，展示了如何使用 Libuv 异步读取文件并写入到另一个文件：

```{literalinclude} /src/libuv/sync-readwrite/main.c
:language: c
```